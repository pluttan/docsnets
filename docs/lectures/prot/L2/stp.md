# STP

**Spanning Tree Protocol (STP)** — это сетевой протокол канального уровня (уровень 2 модели OSI), который предотвращает петли в Ethernet-сетях с избыточными путями. STP автоматически блокирует избыточные пути, оставляя один активный путь между любыми двумя узлами сети, что делает её топологию "деревом" (spanning tree).

STP определён в стандарте **IEEE 802.1D**. Существуют и другие версии протокола, такие как **RSTP (802.1w)**, **MSTP (802.1s)** и **PVST+**.

## Задачи STP
1. **Предотвращение петель (широковещательного шторма):**  
   Петли в сетях вызывают бесконечное дублирование кадров, перегрузку каналов и падение сети.
2. **Предотвращение нестабильность работы таблицы коммутации:**
    При образовании петель один и тот же кадр идет с разныхх соторон.
3. **Автоматическое восстановление:**  
   Если активный путь выходит из строя, STP автоматически активирует резервный путь.
4. **Оптимизация трафика:**  
   Использование наиболее оптимального пути для передачи данных.

## Основные понятия STP

1. **Root Bridge (Корневой мост):**  
   - Центральный коммутатор, который является отправной точкой для построения дерева.  
   - Выбирается на основе **Bridge ID**:  
     - Состоит из приоритета (по умолчанию 32768) и MAC-адреса.  
     - Меньшее значение Bridge ID делает устройство Root Bridge.  
   - Все порты Root Bridge находятся в состоянии **Forwarding**.

2. **Root Port (Корневой порт):**  
   - Порт на коммутаторе, который имеет самый короткий путь до Root Bridge.  
   - На каждом не-корневом коммутаторе есть только один Root Port.

3. **Designated Port (Назначенный порт):**  
   - Порт, который обеспечивает наилучший путь к Root Bridge для данного сегмента сети.  
   - На каждом сегменте может быть только один Designated Port.

4. **Blocked Port (Заблокированный порт):**  
   - Порт, который не участвует в передаче данных, чтобы предотвратить петли.  
   - Может быть активирован в случае отказа активного пути.

## Типы сообщений STP

1. **BPDU (Bridge Protocol Data Units):**  
   - Кадры, используемые для обмена информацией между коммутаторами.  
   - Содержат информацию о Root Bridge, стоимости пути, идентификаторах портов и др.
   - Два типа BPDU:  
     - **Configuration BPDU:** Используется для выбора Root Bridge и установки ролей портов.  
     - **Topology Change Notification (TCN):** Сообщает о изменениях в топологии.

2. **Hello BPDU:**  
   - Отправляется Root Bridge каждые 2 секунды.  
   - Содержит информацию о текущей топологии.

## Алгоритм работы STP

1. **Выбор Root Bridge:**  
   - Все коммутаторы обмениваются BPDU.  
   - Коммутатор с наименьшим Bridge ID становится Root Bridge.

2. **Выбор Root Port:**  
   - Для каждого не-корневого коммутатора выбирается порт с наименьшей стоимостью пути к Root Bridge.

3. **Выбор Designated Port:**  
   - На каждом сегменте сети выбирается порт с наименьшей стоимостью пути к Root Bridge.  
   - Этот порт становится Designated Port.

4. **Блокировка избыточных портов:**  
   - Порты, которые не являются Root Port или Designated Port, переходят в состояние Blocked.

## Состояния портов STP

1. **Disabled:**  
   Порт выключен и не обрабатывает кадры STP.

2. **Blocking:**  
   - Порт включён, но не пересылает данные.  
   - Принимает BPDU и ждёт, не участвуя в топологии.

3. **Listening:**  
   - Порт слушает BPDU и готовится к переходу в активное состояние.  
   - Длится 15 секунд по умолчанию.

4. **Learning:**  
   - Порт изучает MAC-адреса, но ещё не пересылает данные.  
   - Длится 15 секунд по умолчанию.

5. **Forwarding:**  
   - Порт полностью активен.  
   - Пересылает данные и обрабатывает BPDU.

## Версии STP

1. **STP:**  
   - Медленное срабатывание (до 50 секунд для полного восстановления топологии).

2. **RSTP (Rapid STP):**  
   - Rapid Spanning Tree Protocol.  
   - Ускоряет процесс восстановления до нескольких секунд.  
   - Вводит новые состояния портов: Alternate root (В случает отвала основного станет Root) и Backup (В случает отвала основного станет Designated).

3. **PVSTP (Per VLAN STP)**  
   - Создаёт отдельное дерево для каждого VLAN.


## Параметры STP

1. **Cost (Стоимость):**  
   - Определяет "цену" пути до Root Bridge.  
   - Меньшее значение указывает на предпочтительный путь.  
   - Стоимость порта зависит от его расстояния до Root  
   - Стоимость порта зависит от его скорости:  
     - 10 Mbps: 100  
     - 100 Mbps: 19  
     - 1 Gbps: 4  
     - 10 Gbps: 2

2. **Bridge Priority:**  
   - Уровень приоритета коммутатора.  
   - По умолчанию: 32768.  
   - Для повышения шансов стать Root Bridge — уменьшите приоритет.

3. **Hello Time:**  
   - Интервал между Hello BPDU (по умолчанию 2 секунды).

4. **Forward Delay:**  
   - Время нахождения порта в состояниях Listening и Learning (по умолчанию 15 секунд).

5. **Max Age:**  
   - Максимальное время, в течение которого BPDU считается актуальным (по умолчанию 20 секунд).