import PDU from '../../../../static/lib/pdu'
import Mermaid from '../../../../static/lib/Mermaid'

# IPv4

## Основная информация

IPv4 (Internet Protocol version 4) — это четвертая версия интернет-протокола, широко используемая для идентификации устройств в сети и маршрутизации данных между ними. Адрес IPv4 состоит из 32 битов, что позволяет создать около 4,3 миллиарда уникальных адресов.

IPv4 состоит из 4 октетов (октет — 8 бит), записывается в десятичной системе счисления по октетам (например, 255.255.255.0).

<PDU maxCellSize={2} data={[
    { 
        size: 1, 
        name: "Адрес сети", 
        desc: `Уникальный идентификатор сети, к которой относится данный хост.`
    },
    { 
        size: 1, 
        name: "Адрес хоста", 
        desc: "Уникальная часть адреса каждого устройства в сети" 
    }
]} />


По сути, адрес сети — это номер многоквартирного дома, а адрес хоста — номер квартиры, если конечным пунктом назначения является квартира.

Между сетью и хостом есть граница.

## Классовая адресация

Если IP задан классовым подходом (VLSM - Variable Length Subnet Mask), то его можно отнести к одному из 5 классов (| - граница между сетью и хостом):

- **Класс A**: `___|___.___.___`
- **Класс B**: `___.___|___.___`
- **Класс C**: `___.___.___|___`
- **Класс D**: `___.___.___.___|` (групповая рассылка)
- **Класс E** — зарезервирован для будущего использования.

Классы A, B, C различаются числом октетов, выделяемых под адрес сети/хоста. Класс D предназначен для групповой рассылки, а класс E зарезервирован и не используется.

При классовой адресации, классы различаются по первому октету:

| Класс сети | Значение первого октета (двоичная система) | Значение первого октета (десятичная система) |
|------------|--------------------------------------------|---------------------------------------------|
| A          | 0xxxxxxx                                   | 0 - 127                                     |
| B          | 10xxxxxx                                   | 128 - 191                                   |
| C          | 110xxxxx                                   | 192 - 223                                   |
| D          | 1110xxxx                                   | 224 - 239                                   |
| E          | 1111xxxx                                   | 240 - 255                                   |

- **Класс A**: используется для больших сетей. Первый бит равен 0, адреса с первым октетом в диапазоне от 0 до 127.
- **Класс B**: используется для средних сетей. Первый бит равен 1, второй — 0, диапазон от 128 до 191.
- **Класс C**: используется для малых сетей. Первые два бита равны 1, а третий — 0, диапазон от 192 до 223.
- **Класс D**: для мультикастов. Первые три бита равны 1, а четвертый — 0, диапазон от 224 до 239.
- **Класс E**: зарезервирован для будущего использования, диапазон от 240 до 255.

В классе A: 128 сетей, 16 777 216 хостов,  
классе B: 16 384 сетей, 65 025 хостов,  
классе C: 2 080 800 сетей, 255 хостов.

## Бесклассовая адресация

При бесклассовой адресации (CIDR - Classless Inter-Domain Routing), граница между сетью и хостом может быть где угодно. Границу задает маска — 4 октета, набор единиц (сеть) и нулей (хосты). Пример:

```plaintext
192.168.0.1 255.255.0.0
192.168.0.1/16 — кол-во единиц в маске

192.168.0.1 = 11000000.10101000|00000000.00000001
255.255.0.0 = 11111111.11111111|00000000.00000000
              cccccccc cccccccc|хххххххх хххххххх
```

## Зарезервированные адреса

- **Адрес сети**: все биты, отведенные под адреса хостов, заполнены нулями (например, 192.168.1.0).
- **Локальный широковещательный адрес**: все биты заполнены единицами (255.255.255.255).
- **Направленный широковещательный адрес**: все биты хостов заполнены единицами (например, 192.168.1.255).
- **Неопределенный адрес**: все биты IP-адреса равны нулю (0.0.0.0), используется при присвоении IP-адреса.
- **Адрес возвратной петли (localhost)**: сеть 127.0.0.0 для связи устройства с самим собой.
- **Адрес автоконфигурации**: сеть 169.254.0.0, назначается при отсутствии автоматического IP.

## Частные и публичные адреса

IP-адреса делятся на частные и публичные. Частные адреса работают в пределах своей сети, публичные — доступны в интернете.

### NAT - Network Address Translation

NAT подменяет IP при выходе из локальной сети. Варианты NAT:

1. **Статическая**: прописаны пары публичный-частный IP.
2. **Динамическая**: диапазон публичных IP, которые можно раздавать.
3. **PAT (Port Address Translation)**: одному публичному IP назначается множество частных IP.

Диапазоны частных IP:

| Класс сети | Диапазон частных адресов          |
|------------|-----------------------------------|
| A          | 10.0.0.0 – 10.255.255.255        |
| B          | 172.16.0.0 – 172.31.255.255      |
| C          | 192.168.0.0 – 192.168.255.255    |

## Заголовок

<PDU maxCellSize={32} data={[
    { 
        size: 4, 
        name: "Номер версии", 
        desc: `Номер версии IP, тут всегда 4`
    },
    { 
        size: 4, 
        name: "Длина заголовка", 
        desc: `Общая длина, считая параметры`
    },
    { 
        size: 8, 
        name: "Тип сервиса", 
        desc: `Обеспечение качества обслуживания`
    },
    { 
        size: 16, 
        name: "Длина пакета", 
        desc: `Длина данных, идущих после заголовка`
    },
    { 
        size: 16, 
        name: "ID пакета", 
        desc: `Поток бьется на фрагменты, если в канал связи не входит`
    },
    { 
        size: 3, 
        name: "Флаги", 
        desc: `3 бита. Второй определяет разрешена ли фрагментация, третий последний ли фрагмент.`
    },
    { 
        size: 13, 
        name: "Указатель фрагмента", 
        desc: `Позволяет склеить фрагменты в нужной последовательности`
    },
    { 
        size: 8, 
        name: "Время жизни", 
        desc: `TTL(time to life) - число, определяющее сколько раз пакет пройдет через устройства сетевого уровня до того, как будет уничножен. Нужно для избежания петли маршрутизации. В момент достижения нулевого значения данным полем пакет уничтожается, а устройству-источнику отправляется сообщение о причине отбрасывания пакета (истекло время жизни пакета). Максимальное значение данного поля составляет 255. `
    },
    { 
        size: 8, 
        name: "Протокол", 
        desc: `Код протокола, которому необходимо передать данные.`
    },
    { 
        size: 16, 
        name: "Контрольная сумма", 
        desc: `Ловит ошибки, покрывает только заголовок.`
    },
    { 
        size: 32, 
        name: "Адрес источника", 
        desc: `IP-адрес, от которого идет пакет`
    },
    { 
        size: 32, 
        name: "Адрес получателя", 
        desc: `IP-адрес, кому предназначен пакет`
    },
    { 
        size: 32, 
        name: "Параметры | Заполнитель", 
        desc: `Параметры пакета. Делатся на 4 класса, 0 и 2 зарезервированны. 1 для дейтограммы пользователя, 3 для отладки и диагностики.`
    },
]} />

### Тип сервиса

|P|P|P|D|T|R|ECN|ECN|
|-|-|-|-|-|-|---|---|

- Три бита **P** поля "Тип сервиса" (**precedence** – приоритет) указывают приоритет пакета.
- **Бит D** (*delay* – задержка) – предъявляет требование к минимальной задержке для данного IP-пакета.
- **Бит T** (*throughput* – пропускная способность) – предъявляет требование к максимальной пропускной способности канала, по которому будет отправлен данный IP-пакет.
- **Бит R** (*reliability* – надежность) – предъявляет требование к минимальной вероятности ошибки в канале, по которому будет передан данный IP-пакет.
- **Два бита ECN** (*Explicit Congestion Notification* – явное сообщение о задержке) обеспечивают управление IP-потоком, возможное при поддержке обеими сторонами.

  Заторы в сети приводят к потере пакетов, так как переполненные буферы оборудования начинают отбрасывать поступающие пакеты. Это и указывает на затор, если **ECN-сессия** не установлена. При наличии ECN-сессии маршрутизаторы сигнализируют о заторе, устанавливая соответствующие биты в поле **ECN**, чтобы вышележащие маршрутизаторы могли снизить скорость передачи или остановить её. Таким образом, ECN-сессия позволяет предупреждать потери пакетов, регулируя поток и предотвращая переполнение.


## Виды получения IP

- Настройка вручную 
- Использование [DHCP](./dhcp.md)