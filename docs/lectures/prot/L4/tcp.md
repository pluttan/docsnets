import PDU from '../../../../static/lib/pdu'
import Mermaid from '../../../../static/lib/Mermaid'
import IframeComponent from '../../../../static/lib/iframe'

# TCP

## Сегмент TCP

<PDU maxCellSize={32} name={'Заголовок TCP'} data={[
    { 
        size: 16, 
        name: "Порт источника"
    },
    { 
        size: 16, 
        name: "Порт назначения"
    },
    { 
        size: 32, 
        name: "Номер последовательности", 
        desc: `Когда флаг синхронизации SYN=0: номер первого байта; SYN=1 начальный номер последовательности ISN`
    },
    { 
        size: 32, 
        name: "Номер подтверждения", 
        desc: `Номер последовательности которая ожидается в следующий раз`
    },
    { 
        size: 4, 
        name: "Длина"
    },
    { 
        size: 4, 
        name: "Зарезервировано", 
        desc: `1 бит: ESN(сессия установлена), 2 бит: Изменяется скорость, 3 бит: изменение остальных параметров`
    },
    { 
        size: 8, 
        name: "Флаги", 
        desc: `Смотри ниже`
    },
    { 
        size: 16, 
        name: "Размер окна", 
        desc: `Объем данных, которые можно передать без подтверждения`
    },
    { 
        size: 16, 
        name: "Контрольная сумма"
    },
    { 
        size: 16, 
        name: "Указатель важности", 
        desc: `Положительное смещение, покрывающее важные данные`
    },
    { 
        size: 32, 
        name: "Опции", 
        desc: `Тип|Длина|Данные|Заполнитель (пример: договор о максимальном размере соединения, о неразрывности соединения и т.д.)`
    },
]} />

## Флаги

- `URG` поле указания важности валидно
- `ACK` данный сегмент является подтверждением предыдущего
- `PSH` данный сегмент необходимо отправить незамедлительно
- `RST` аварийное закрытие соединения
- `SYN` синхронизания, если выставлена установка соединения.
- `FIN` корректное закрытие соединение

## Размер окна

![](../../imgs/tcpWindowLength.drawio.svg)

Источник переслал n сегментов и ждет подтвержнение первого, чтоб переслать n+1 сегмент. Как только он его получает он пересылает n+1 и ждет подтверждение 2 и так далее. n может варьироваться в зависимости от устройства.

## Трехсторонее тикирование или рукопожатие

![](../../imgs/tcpTick.drawio.svg)


## Таймеры для контроля TCP

#### Retransmission Timer (RTO - Retransmission Timeout)
- **Назначение:** Отвечает за повторную передачу данных, если ACK (подтверждение) от получателя не был получен в заданный промежуток времени.
- **Механизм:**
  - Таймер запускается при передаче сегмента.
  - Если таймер истекает до получения ACK, сегмент передается повторно.
  - Время ожидания рассчитывается динамически с использованием **RTT (Round Trip Time)**.
- **Проблемы:** Если таймер слишком короткий, это может привести к лишним повторным передачам. Если слишком длинный — к задержкам в доставке данных.

#### Keepalive Timer
- **Назначение:** Проверяет состояние соединения, если приложение не передает данные длительное время.
- **Механизм:**
  - Периодически отправляются **keepalive-сегменты** (пустые пакеты) для проверки доступности другого конца.
  - Если в ответ не получено ACK в течение определенного времени, соединение считается разорванным.
- **Значение по умолчанию:** обычно 2 часа, но может быть настроено.

#### TIME-WAIT Timer
- **Назначение:** Управляет состоянием `TIME-WAIT`, которое возникает после завершения соединения.
- **Механизм:**
  - После отправки последнего ACK сторона инициирующая закрытие соединения остается в состоянии `TIME-WAIT` в течение определенного времени (обычно 2 * Maximum Segment Lifetime, или **MSL**, по умолчанию 60 секунд).
  - Это предотвращает интерференцию между старым и новым соединением с теми же параметрами (IP и порты).

#### Persist Timer
- **Назначение:** Предотвращает возникновение "дедлока", если окно стало равным нулю.
- **Механизм:**
  - Если получатель сообщает отправителю, что его окно равно нулю, отправитель периодически отправляет пустые пакеты (Probe), чтобы проверить, не освободилось ли окно.
  - Если окно больше нуля, передача данных возобновляется.


#### Таблица основных таймеров TCP

| **Таймер**           | **Назначение**                                 | **Типичный интервал**     |
|-----------------------|-----------------------------------------------|---------------------------|
| Retransmission Timer  | Повторная передача данных                     | Зависит от RTT            |
| Delayed ACK Timer     | Задержка отправки ACK                        | Около 200 мс              |
| Keepalive Timer       | Проверка доступности соединения              | Обычно 2 часа (настраиваемый) |
| TIME-WAIT Timer       | Задержка закрытия соединения                 | 2 * MSL (обычно 60 сек)   |
| Persist Timer         | Избежание дедлока при Zero Window            | Зависит от настроек       |
| SYN Timer             | Ожидание SYN+ACK                             | Зависит от конфигурации   |
| Connection Timer      | Тайм-аут установки соединения                | Обычно 75 секунд          |

