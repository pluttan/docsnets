# ICMP и ARP  


Рассмотрим, как работает ICMP в локальной сети и каким образом ARP помогает ему достичь цели.  

Допустим, мы хотим отправить ICMP-пакет от одного компьютера к другому в локальной сети. Поскольку это локальная сеть, пакет будет проходить только через устройства канального уровня. В этом случае ARP-таблицы будут только на отправителе и получателе.  

### Сборка топологии  

Соберем такую топологию (коммутаторы настраивать не нужно). Зададим компьютерам IP-адреса:  
- PC0: 192.168.0.1  
- PC1: 192.168.0.2  

Теперь отправим один ICMP-пакет:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.37.47 PM.png)  

Мы видим, что вместо одного пакета отправилось два. Это связано с тем, что на PC0 еще нет записи в ARP-таблице. Сначала он должен узнать MAC-адрес устройства, которому адресован ICMP-пакет. Для этого PC0 выполняет ARP-рассылку с широковещательным адресом перед отправкой ICMP.  

Наводим курсор на пакеты, чтобы узнать их тип:  
![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.38.05 PM.png)  
![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.38.00 PM.png)  

Как видно, наши предположения подтвердились. Запускаем симуляцию:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.38.15 PM.png)  

Первым отправляется ARP-запрос. Развернем его:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.38.39 PM.png)  

Во вкладке с деталями пакета видим, что на канальном уровне используется протокол Ethernet2, а на сетевом уровне — ARP. В поле DEST ADDR в Ethernet2 указан широковещательный MAC-адрес.  

### Ответ на ARP-запрос  

Широковещательный MAC позволяет PC1 прочитать запрос. На сетевом уровне, в поле TARGET IP, он видит, что запрос адресован ему. Поэтому PC1 создает ARP-ответ:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.38.50 PM.png)  

Ответ отправляется обратно к PC0. Проверим ARP-таблицу на PC1. Для этого введем команду:  
```bash
arp -a
```  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%201.00.55 PM.png)  

PC1 узнал IP-адрес из поля SOURCE IP запроса, а MAC-адрес — из SOURCE MAC.  

### Что содержится в ARP-ответе?  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.39.01 PM.png)  

В ответе содержится MAC-адрес, необходимый PC0 для отправки ICMP-пакета, это unicast рассылка, то есть он адресован только PC0. 

### Роль коммутаторов  

У коммутаторов есть MAC-таблицы. Они похожи на ARP-таблицы, но вместо IP-адресов используют номера интерфейсов. Как только кадр проходит через коммутатор, он заполняет свою таблицу новым MAC-адресом, что позволяет рассылать пакеты точно по назначению.  

Тем временем ARP-ответ доходит до PC0, который использует полученные данные для подготовки ICMP-пакета:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.39.37 PM.png)  

Теперь в Ethernet2 указан MAC-адрес PC1, а значит, пакет можно отправлять.  
-![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.39.53 PM.png)  

Без проблем пакет достигает PC1, и тот отправляет ответ.  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.40.01 PM.png)  

Ответ успешно возвращается к PC0.  

### Проверка результата  

Посмотрим состояние симуляции:  

![](./ARP&ICMP/Снимок%20экрана%202024-11-17%20в%2012.40.08 PM.png)

В поле статуса видим сообщение *Successful*. Это означает, что компьютеры успешно обменялись ICMP-пакетами (команда "ping" отработала корректно).


