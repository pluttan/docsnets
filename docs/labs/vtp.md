# VTP

Помните ёлочку из предыдущей статьи? На самом деле их две: одна — с STP, другая — без, а также есть "звездочка". Объединим всё вместе и добавим по компьютеру на концах. Задача — отправить данные с одного компьютера на другой:

![](./vtp/Снимок%20экрана%202024-11-22%20в%205.57.37 PM.png)

Правая ёлочка находится в VLAN 2. Это значит, что через неё будут идти пакеты из VLAN 1. Но когда они будут проходить через нижний коммутатор, он будет добавлять тег VLAN 2, и по левой ёлочке кадры пойдут уже с этим тегом.

### Настройка роутера
Настроим роутер, как описано [здесь](./rtvlan).

Нужно, чтобы левая ёлочка знала о VLAN 2. Настройка вручную заняла бы слишком много времени, поэтому используем протокол [VTP](../lectures/prot/L2/vtp). Он работает только на **trunk**-портах, поэтому для всех коммутаторов в ёлочках зададим **trunk** на интерфейсах:

```
interface range FastEthernet 0/1-3
switchport mode trunk
```

### Настройка ролей VTP

1. Для нижнего коммутатора задаем домен `c` и роль **VTP-сервера**:
   ```
   vtp domain c
   vtp mode server
   ```

2. Для всех коммутаторов левой ёлочки задаем роль **VTP-клиента**:
   ```
   vtp domain c
   vtp mode client
   ```

3. Для всех коммутаторов правой ёлочки задаем роль **VTP-прозрачного режима**:
   ```
   vtp domain c
   vtp mode transparent
   ```

На уровне сети, компьютеры правой ёлочки используют **Default Gateway** (DG) для VLAN 2. Но коммутаторы работают на уровне ниже, поэтому вся правая ёлочка воспринимает пакеты как относящиеся к VLAN 1.

### Создание VLAN

На коммутаторе с ролью **VTP-сервера** создадим VLAN 2:
```
vlan 2
name vlan2
exit
interface FastEthernet0/1
switchport allow vlan 2
exit
```

Теперь все коммутаторы с ролью клиента автоматически узнают о VLAN 2, и пакеты с правой ёлочки будут приходить в левую с тегом VLAN 2.

### Проверка связи

Попробуем пинговать один компьютер с другого.

![](./vtp/Снимок%20экрана%202024-11-22%20в%206.04.11 PM.png)  

Пройдя длинный путь через обе ёлочки, **ARP**-запрос попал в роутер и был удалён, так как на роутере отсутствовала **ARP**-таблица.

![](./vtp/Снимок%20экрана%202024-11-22%20в%206.05.53 PM.png)  

Теперь роутер отправил ARP-запрос в сеть со "звездочкой" и получил ответ, благодаря чему таблица была заполнена. Попробуем отправить пакет ещё раз.

![](./vtp/Снимок%20экрана%202024-11-22%20в%206.34.12 PM.png)  
![](./vtp/Снимок%20экрана%202024-11-22%20в%206.45.47 PM.png)  
![](./vtp/Снимок%20экрана%202024-11-22%20в%206.47.21 PM.png)  
![](./vtp/Снимок%20экрана%202024-11-22%20в%206.47.32 PM.png)  

**Успех!**

Убедимся, что свитчи в левой елочке действительно знают про vlan2 (хотя то, что ICMP запрос прошел уже это доказывает):

```
show vlan brief
```

![](./vtp/Снимок%20экрана%202024-11-23%20в%202.07.55 PM.png)
