# STP

Начнем изучение [STP](../lectures/prot/L2/stp).  
Этот протокол значительно упрощает жизнь сетевикам, поскольку самостоятельно обнаруживает петли в сети и предотвращает их на логическом уровне, до того как они вызовут проблемы на физическом уровне.

### Что мы изучим:
- Как отключать протокол STP.
- Создание широковещательного шторма.
- Настройка мест, где STP будет разрывать соединение.
- Настройка root-коммутатора.
- Определение root-коммутатора.

Надеюсь, вы читаете это не под Новый год. Но если это так, добавим немного праздничного настроения, создав такую топологию:

![](./stp/Снимок%20экрана%202024-11-21%20в%205.16.18 PM.png)  
*Ёлочка.*

По умолчанию протокол STP включен на всех VLAN и коммутаторах, поэтому все петли разорваны. Уберем "звездочку" с ёлочки и отключим STP на VLAN 1 и 2:

```
no spanning-tree vlan 1,2
```

![](./stp/Снимок%20экрана%202024-11-21%20в%205.25.43 PM.png)

Заметим, что VLAN 2 в сети пока не существует. Это сделано на будущее.  
Во время отключения STP на некоторых коммутаторах, другие начали генерировать широковещательные пакеты, и шторм начался.

Теперь попробуем устранить шторм без STP. Будем искать петли и разрывать их вручную, отключая интерфейсы:

```
shutdown
```

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.09.41 PM.png)  
*Я убрал все подписи, чтобы вам ничего не мешало.*

Теперь вспомним теорию: если бы порты перекрывались STP, как бы они выглядели?  
Порты имеют три состояния:  
- **Root Port (rb)** — порт на коммутаторе, обеспечивающий самый короткий путь до Root Bridge.  
- **Designated Port (d)** — порт, предоставляющий наилучший путь к Root Bridge для данного сегмента сети.  
- **Blocked Port (b)** — порт, который необходимо заблокировать для предотвращения петель.  

Без изменения root-коммутатора и топологии порт состояния **rb** можно перевести в **b**, но не в **d**. Это возможно, если разрыв соединения будет происходить в точке, через которую проходит максимальное количество коммутаторов с обеих сторон (например, между 3 и 4 или 4 и 5, если root = 1).  

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.06.44 PM.png)

Расставили порты. Теперь включим STP обратно и реализуем аналогичные блокировки через протокол. Root будет верхушкой ёлки.

### Полезные команды:

```
sw(config)# spanning-tree vlan 1,2
sw(config)# spanning-tree vlan 1,2 root primary
sw(config-if)# spanning-tree cost 1
sw(config-if)# spanning-tree cost 200000000
sw(config-if)# speed 10
sw(config-if)# speed 100
```

Используя эти команды на разных коммутаторах, получили следующую схему:

![](./stp/Снимок%20экрана%202024-11-22%20в%205.44.25 PM.png)

Теперь поговорим о снятой "звездочке" с ёлки:

![](./stp/Снимок%20экрана%202024-11-22%20в%205.46.57 PM.png)

Разберем топологию, чтобы провода не пересекались:

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.44.42 PM.png)

### Определение root-коммутатора:
1. Отметим порты **b**, напротив них будут **d**.

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.45.02 PM.png)

2. Остальные интерфейсы этих коммутаторов будут **rb**, а противоположные — **d**.

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.45.37 PM.png)

3. По этой же логике находим root-коммутатор:

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.49.33 PM.png)

### Проверка:

```
show spanning-tree
```

![](./stp/Снимок%20экрана%202024-11-23%20в%2012.52.51 PM.png)  